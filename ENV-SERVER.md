# Что прописать в .env на сервере (бэкенд Harmony)

Ниже — **обязательные и рекомендуемые переменные** для production. Без правильных значений бэкенд в `NODE_ENV=production` не запустится.

---

## 1. Подключение приложения к API (защита от посторонних)

| Переменная | Описание | Пример |
|------------|----------|--------|
| **APP_KEY** | Секретный ключ приложения. **Тот же ключ** должен быть в приложении (Harmony App). Все запросы к API (кроме health и оплаты) должны отправлять заголовок `X-Harmony-App-Key: <значение>`. В production — **минимум 32 символа**, случайная строка. | `a7f2b9c4d1e8...` (32+ символов) |

**В приложении** (React Native/Expo) в конфиге/env задайте тот же ключ и добавляйте заголовок ко всем запросам к бэкенду:
```text
X-Harmony-App-Key: <ваш APP_KEY>
```

---

## 2. JWT (сессии и токены)

| Переменная | Описание | Пример |
|------------|----------|--------|
| **JWT_ACCESS_SECRET** | Секрет для access-токенов. В production — **минимум 32 символа**, случайная строка. | Длинная случайная строка |
| **JWT_REFRESH_SECRET** | Секрет для refresh-токенов. Должен отличаться от JWT_ACCESS_SECRET. **Минимум 32 символа**. | Другая длинная случайная строка |

---

## 3. CORS (доступ с браузера)

| Переменная | Описание | Пример |
|------------|----------|--------|
| **CORS_ORIGIN** | В production **нельзя** оставлять `*`. Укажите точный домен приложения (или несколько через запятую). | `https://yourapp.com` или `https://app.harmony.com,https://harmony.com` |

Для только мобильного приложения можно указать ваш основной домен (например, сайт).

---

## 4. Ключ для сайта / внешних сервисов

| Переменная | Описание | Пример |
|------------|----------|--------|
| **SITE_API_KEY** | Ключ для запросов с сайта (например, продление подписки). В production — **свой ключ минимум 24 символа**, не оставляйте значение по умолчанию. | Случайная строка 24+ символов |

---

## 5. База данных

В Docker на сервере **DATABASE_URL** задаётся в `docker-compose` (контейнер `postgres`). В `.env` можно не переопределять, если используете compose как в репозитории.

Если поднимаете БД отдельно — задайте в `.env`:
```env
DATABASE_URL=postgresql://USER:PASSWORD@host:5432/harmony
```
Пароль БД сделайте **сложным** (не `harmony_secret` в production).

---

## 6. Остальное

| Переменная | Описание |
|------------|----------|
| **NODE_ENV** | `production` |
| **PORT** | `3000` (или другой, если меняете в compose) |
| **API_PREFIX** | `/api` |
| **THROTTLE_TTL_SECONDS** | Секунды окна для лимита запросов (по умолчанию 60) |
| **THROTTLE_LIMIT** | Макс. запросов с одного IP в окне (по умолчанию 30). Можно уменьшить для жёсткой защиты (например, 20). |
| **SUPPORT_TELEGRAM_URL** | Ссылка на поддержку (например, `https://t.me/harmony_support`) |
| **SUBSCRIPTION_SITE_URL** | URL страницы подписки на сайте |

Опционально (если используете):  
`APPLE_SHARED_SECRET`, `YOOKASSA_SHOP_ID`, `YOOKASSA_SECRET_KEY`, `ANDROID_PACKAGE_NAME`, Firebase (`FIREBASE_PROJECT_ID`, `FIREBASE_CLIENT_EMAIL`, `FIREBASE_PRIVATE_KEY`).

---

## Генерация секретов (одна команда на сервере)

На сервере можно сгенерировать строки для `APP_KEY`, JWT и `SITE_API_KEY`:

```bash
# По одной строке на переменную (вставить в .env)
openssl rand -base64 32   # для APP_KEY, JWT_ACCESS_SECRET, JWT_REFRESH_SECRET
openssl rand -base64 24   # для SITE_API_KEY
```

---

## Пример .env для production (минимум)

Замените значения на свои (сгенерированные выше).

```env
NODE_ENV=production
PORT=3000
API_PREFIX=/api

# Сгенерируйте свои (openssl rand -base64 32)
JWT_ACCESS_SECRET=ваш_секрет_32_символа_или_длиннее
JWT_REFRESH_SECRET=другой_секрет_32_символа_или_длиннее

# Ключ приложения — тот же в приложении в заголовке X-Harmony-App-Key (32+ символов)
APP_KEY=ваш_ключ_приложения_32_символа_или_длиннее

# Домен вашего приложения/сайта (не *)
CORS_ORIGIN=https://yourapp.com

# Ключ для запросов с сайта (24+ символов)
SITE_API_KEY=ваш_ключ_сайта_24_символа

# Лимиты запросов (по желанию ужесточить)
THROTTLE_TTL_SECONDS=60
THROTTLE_LIMIT=20

SUPPORT_TELEGRAM_URL=https://t.me/harmony_support
SUBSCRIPTION_SITE_URL=https://harmony.app/premium
```

**DATABASE_URL** в Docker задаётся в `docker-compose`; в `.env` на сервере его можно не дублировать, если пароль БД меняете через переменные окружения compose.

---

## Что сделать по шагам

1. На сервере перейти в каталог бэкенда: `cd /root/backend-harmony`.
2. Скопировать пример: `cp env.docker.example .env`.
3. Открыть `.env`: `nano .env`.
4. Заменить все значения по таблицам выше (APP_KEY, JWT_*, CORS_ORIGIN, SITE_API_KEY и т.д.).
5. В **приложении** (Harmony App) прописать тот же **APP_KEY** и добавлять заголовок **X-Harmony-App-Key** ко всем запросам к этому API.
6. Перезапустить контейнеры: `docker compose up -d --build`.

После этого только ваше приложение (с правильным ключом) и ваш сайт (с правильным SITE_API_KEY) смогут пользоваться API; случайные запросы без ключа получат 401.
