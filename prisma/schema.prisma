generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String    @id @default(uuid())
  email          String    @unique
  name           String
  surname        String    @default("")
  passwordHash   String?
  premiumUntil   DateTime?
  nameUpdatedAt  DateTime  @default(now())
  nameChangeCount Int      @default(0)
  createdAt      DateTime  @default(now())
  deletedAt      DateTime?

  refreshSessions RefreshSession[]
  devices         Device[]
  subscription    Subscription?
  yookassaPayments YookassaPayment[]
}

model RefreshSession {
  id           String    @id @default(uuid())
  userId       String
  expiresAt    DateTime
  revokedAt    DateTime?
  replacedById String?
  ip           String?
  userAgent    String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
}

model Device {
  id             String   @id
  userId         String
  platform       String?
  pushToken      String?
  preferredLocale String?
  lastSeenAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
}

model Subscription {
  userId       String   @id
  productId    String
  store        String?  // INTERNAL | APPLE | GOOGLE
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  updatedAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model YookassaPayment {
  id                 String    @id
  planId              String
  emailOrId           String
  status              String
  userId              String?
  grantedAt           DateTime?
  createdAt           DateTime  @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  @@index([emailOrId])
}

model AuthLockout {
  key        String   @id
  attempts   Int      @default(0)
  lockedUntil DateTime?
  updatedAt  DateTime  @default(now())
}

// Админы панели: создаются только из консоли (npm run create-admin). Пароль — хэш argon2.
model Admin {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
}

// --- Контент приложения: секции, треки, статьи (главная) ---

model ContentSection {
  id        String   @id @default(uuid())
  name      String   // Название раздела (для админки и приложения)
  slug      String   @unique // relaxation, inspiration, love, nightmare_exclusion, etc.
  type      String   // MEDITATION | SLEEP
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tracks ContentTrack[]
}

model ContentTrack {
  id              String   @id @default(uuid())
  sectionId       String
  title           String
  descriptionShort String  @default("") // Короткое описание для карточки
  coverUrl        String?  // URL обложки (/uploads/covers/...)
  audioUrl        String?  // URL аудио (/uploads/tracks/...)
  level           String?  // Уровень А/В/С
  isPremium       Boolean  @default(false)
  sortOrder       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  section ContentSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  @@index([sectionId])
}

// Статьи только для главного экрана (блоки: featured, recommended, emergency)
model Article {
  id               String    @id @default(uuid())
  blockType        String    // FEATURED | RECOMMENDED | EMERGENCY
  title            String
  descriptionShort String    @default("")
  descriptionFull  String?   @db.Text
  imageUrl         String?
  sortOrder        Int       @default(0)
  publishedAt      DateTime? @default(now())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([blockType])
}
